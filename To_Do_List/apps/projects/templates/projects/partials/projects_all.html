{% for project in projects %}
<div class="project-card mb-4" id="project-{{ project.pk }}">
    <!-- Project Header -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar3 me-2"></i>
                <h5 class="mb-0">{{ project.name }}</h5>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-link text-white"
                        hx-get="{% url 'projects:project_update' project.pk %}"
                        hx-target="#project-form-modal"
                        hx-swap="innerHTML"
                        data-bs-toggle="modal"
                        data-bs-target="#projectModal">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-link text-white"
                        hx-delete="{% url 'projects:project_delete' project.pk %}"
                        hx-confirm="Are you sure you want to delete this project?"
                        hx-target="#project-{{ project.pk }}"
                        hx-swap="outerHTML">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Project Body -->
    <div class="project-body">
        <!-- Add Task Form -->
        <div class="task-input-container mb-3">
            <form hx-post="{% url 'tasks:task_create' project.pk %}"
                  hx-target="#tasks-{{ project.pk }}"
                  hx-swap="beforeend"
                  class="d-flex align-items-center">
                {% csrf_token %}
                <i class="bi bi-plus-lg text-success me-2"></i>
                <input type="text"
                       name="title"
                       class="form-control form-control-task"
                       placeholder="Start typing here to create a task..."
                       required>
                <button type="submit" class="btn btn-add-task">Add Task</button>
            </form>
        </div>

        <!-- Tasks List -->
        <div id="tasks-{{ project.pk }}" class="sortable-tasks" data-project-id="{{ project.pk }}">
            {% for task in project.tasks.all %}
                {% include "tasks/partials/task_item.html" %}
            {% empty %}
                <!-- No tasks message can be added here if needed -->
            {% endfor %}
        </div>
    </div>
</div>
{% empty %}
<div class="text-center text-muted py-5">
    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
    <h4 class="mt-3">No projects yet</h4>
    <p>Click "Add TODO List" to create your first project</p>
</div>
{% endfor %}

<!-- Hidden button for modal trigger -->
<button id="projectModalBtn" type="button" class="d-none" data-bs-toggle="modal" data-bs-target="#projectModal"></button>

<!-- Task Edit Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="task-edit-modal">
            <!-- Form will be loaded here -->
        </div>
    </div>
</div>

<script>
// Close task modal on successful update
document.body.addEventListener('taskUpdated', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
    if (modal) {
        modal.hide();
    }
});

// Initialize Sortable for drag-and-drop
document.addEventListener('DOMContentLoaded', function() {
    initializeSortable();
});

// Re-initialize after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function() {
    initializeSortable();
});

function initializeSortable() {
    document.querySelectorAll('.sortable-tasks').forEach(function(el) {
        if (!el.sortable) {  // Prevent multiple initializations
            el.sortable = new Sortable(el, {
                handle: '.task-drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    // Task was moved, update order on server
                    const taskIds = Array.from(el.children).map(item => item.id.replace('task-', ''));
                    console.log('New order:', taskIds);
                    // You can add an AJAX call here to save the order
                }
            });
        }
    });
}
</script>
